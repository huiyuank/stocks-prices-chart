import "@testing-library/jest-dom";
import { formatLastNDaysAverage, generateUrl } from "@/utils";
import {
  MOCK_AGGREGATES_AAPL_DATA,
  MOCK_AGGREGATES_MSFT_DATA,
} from "@/mocks/aggregates-data";

const exampleDomain = "https://example.com";
const examplePath = "/path/to/service/{str}";
const testingPathParams = { str: "test" };

describe("generateUrl", () => {
  it("replaces both path params and query params", () => {
    const testingQueryParams = {
      foo: "bar",
      sort: "asc",
    };
    const newUrl = generateUrl(
      exampleDomain,
      examplePath,
      testingPathParams,
      testingQueryParams
    );
    expect(newUrl).toEqual(
      "https://example.com/path/to/service/test?foo=bar&sort=asc"
    );
  });

  it("handles empty value query param", () => {
    const testingQueryParams = {
      foo: "",
      sort: "desc",
    };
    const newUrl = generateUrl(
      exampleDomain,
      examplePath,
      testingPathParams,
      testingQueryParams
    );
    expect(newUrl).toEqual(
      "https://example.com/path/to/service/test?foo=&sort=desc"
    );
  });

  it("handles invalid URL", () => {
    const testingDomain = "www.example.com";
    const newUrl = generateUrl(
      testingDomain,
      examplePath,
      testingPathParams,
      {}
    );
    expect(newUrl).toEqual("");
  });
});

describe("formatLastNDaysAverage", () => {
  it("successfully transforms AAPL stock prices for last 3 days average", () => {
    const formattedResponse = formatLastNDaysAverage(
      MOCK_AGGREGATES_AAPL_DATA,
      3
    );
    expect(formattedResponse[0].results.length).toEqual(
      formattedResponse[0].resultsCount
    );
    expect(formattedResponse[0].ticker).toEqual("AAPL");
    expect(formattedResponse).toEqual([
      {
        ticker: "AAPL",
        queryCount: 24,
        resultsCount: 24,
        adjusted: true,
        results: [
          {
            v: 70790813,
            vw: 131.6292,
            o: 130.465,
            c: 130.15,
            h: 133.41,
            l: 129.89,
            t: 1673240400000,
            n: 645365,
            averageC: 130.15,
            averageO: 130.465,
            averageH: 133.41,
            averageL: 129.89,
          },
          {
            v: 63896155,
            vw: 129.822,
            o: 130.26,
            c: 130.73,
            h: 131.2636,
            l: 128.12,
            t: 1673326800000,
            n: 554940,
            averageC: 130.44,
            averageO: 130.3625,
            averageH: 132.33679999999998,
            averageL: 129.005,
          },
          {
            v: 69458949,
            vw: 132.3081,
            o: 131.25,
            c: 133.49,
            h: 133.51,
            l: 130.46,
            t: 1673413200000,
            n: 561278,
            averageC: 131.45666666666668,
            averageO: 130.65833333333333,
            averageH: 132.72786666666664,
            averageL: 129.49,
          },
          {
            v: 71379648,
            vw: 133.171,
            o: 133.88,
            c: 133.41,
            h: 134.26,
            l: 131.44,
            t: 1673499600000,
            n: 635331,
            averageC: 132.54333333333332,
            averageO: 131.79666666666665,
            averageH: 133.0112,
            averageL: 130.0066666666667,
          },
          {
            v: 57809719,
            vw: 133.6773,
            o: 132.03,
            c: 134.76,
            h: 134.92,
            l: 131.66,
            t: 1673586000000,
            n: 537385,
            averageC: 133.88666666666666,
            averageO: 132.38666666666666,
            averageH: 134.23,
            averageL: 131.1866666666667,
          },
          {
            v: 63612627,
            vw: 135.7587,
            o: 134.83,
            c: 135.94,
            h: 137.29,
            l: 134.13,
            t: 1673931600000,
            n: 595831,
            averageC: 134.70333333333332,
            averageO: 133.58,
            averageH: 135.48999999999998,
            averageL: 132.41,
          },
          {
            v: 69672800,
            vw: 136.3316,
            o: 136.815,
            c: 135.21,
            h: 138.61,
            l: 135.03,
            t: 1674018000000,
            n: 578304,
            averageC: 135.3033333333333,
            averageO: 134.55833333333334,
            averageH: 136.93999999999997,
            averageL: 133.60666666666668,
          },
          {
            v: 58280413,
            vw: 134.9653,
            o: 134.08,
            c: 135.27,
            h: 136.25,
            l: 133.77,
            t: 1674104400000,
            n: 491674,
            averageC: 135.47333333333333,
            averageO: 135.24166666666667,
            averageH: 137.38333333333333,
            averageL: 134.31000000000003,
          },
          {
            v: 80200655,
            vw: 136.3762,
            o: 135.28,
            c: 137.87,
            h: 138.02,
            l: 134.22,
            t: 1674190800000,
            n: 552230,
            averageC: 136.11666666666665,
            averageO: 135.39166666666665,
            averageH: 137.62666666666667,
            averageL: 134.34000000000003,
          },
          {
            v: 81760313,
            vw: 141.2116,
            o: 138.12,
            c: 141.11,
            h: 143.315,
            l: 137.9,
            t: 1674450000000,
            n: 719288,
            averageC: 138.08333333333334,
            averageO: 135.82666666666665,
            averageH: 139.195,
            averageL: 135.2966666666667,
          },
          {
            v: 66435142,
            vw: 142.0507,
            o: 140.305,
            c: 142.53,
            h: 143.16,
            l: 140.3,
            t: 1674536400000,
            n: 498679,
            averageC: 140.50333333333333,
            averageO: 137.90166666666667,
            averageH: 141.49833333333333,
            averageL: 137.4733333333334,
          },
          {
            v: 65799349,
            vw: 140.7526,
            o: 140.89,
            c: 141.86,
            h: 142.43,
            l: 138.81,
            t: 1674622800000,
            n: 536505,
            averageC: 141.83333333333334,
            averageO: 139.77166666666665,
            averageH: 142.96833333333333,
            averageL: 139.0033333333334,
          },
          {
            v: 54105068,
            vw: 143.3429,
            o: 143.17,
            c: 143.96,
            h: 144.25,
            l: 141.9,
            t: 1674709200000,
            n: 472135,
            averageC: 142.78333333333333,
            averageO: 141.45499999999996,
            averageH: 143.28,
            averageL: 140.3366666666667,
          },
          {
            v: 70547743,
            vw: 145.8365,
            o: 143.155,
            c: 145.93,
            h: 147.23,
            l: 143.08,
            t: 1674795600000,
            n: 560022,
            averageC: 143.91666666666669,
            averageO: 142.40499999999997,
            averageH: 144.63666666666668,
            averageL: 141.26333333333335,
          },
          {
            v: 64015274,
            vw: 143.6524,
            o: 144.955,
            c: 143,
            h: 145.55,
            l: 142.85,
            t: 1675054800000,
            n: 551111,
            averageC: 144.29666666666668,
            averageO: 143.76,
            averageH: 145.6766666666667,
            averageL: 142.61,
          },
          {
            v: 65874459,
            vw: 143.6473,
            o: 142.7,
            c: 144.29,
            h: 144.34,
            l: 142.28,
            t: 1675141200000,
            n: 468170,
            averageC: 144.40666666666667,
            averageO: 143.60333333333332,
            averageH: 145.7066666666667,
            averageL: 142.73666666666668,
          },
          {
            v: 77663426,
            vw: 143.8723,
            o: 143.97,
            c: 145.43,
            h: 146.61,
            l: 141.32,
            t: 1675227600000,
            n: 693374,
            averageC: 144.24,
            averageO: 143.875,
            averageH: 145.50000000000003,
            averageL: 142.15,
          },
          {
            v: 118338980,
            vw: 149.3764,
            o: 148.9,
            c: 150.82,
            h: 151.18,
            l: 148.17,
            t: 1675314000000,
            n: 996203,
            averageC: 146.84666666666666,
            averageO: 145.18999999999997,
            averageH: 147.3766666666667,
            averageL: 143.92333333333332,
          },
          {
            v: 154338835,
            vw: 154.2437,
            o: 148.03,
            c: 154.5,
            h: 157.38,
            l: 147.83,
            t: 1675400400000,
            n: 1141350,
            averageC: 150.25,
            averageO: 146.96666666666667,
            averageH: 151.72333333333336,
            averageL: 145.77333333333334,
          },
          {
            v: 69771906,
            vw: 152.0939,
            o: 152.575,
            c: 151.73,
            h: 153.1,
            l: 150.78,
            t: 1675659600000,
            n: 583517,
            averageC: 152.35,
            averageO: 149.83499999999998,
            averageH: 153.88666666666668,
            averageL: 148.9266666666667,
          },
          {
            v: 83322551,
            vw: 153.4202,
            o: 150.64,
            c: 154.65,
            h: 155.23,
            l: 150.64,
            t: 1675746000000,
            n: 661767,
            averageC: 153.62666666666667,
            averageO: 150.41499999999996,
            averageH: 155.23666666666668,
            averageL: 149.75000000000003,
          },
          {
            v: 63620079,
            vw: 152.3636,
            o: 153.88,
            c: 151.92,
            h: 154.58,
            l: 151.168,
            t: 1675832400000,
            n: 524140,
            averageC: 152.76666666666665,
            averageO: 152.36499999999998,
            averageH: 154.30333333333337,
            averageL: 150.86266666666668,
          },
          {
            v: 55994243,
            vw: 152.2769,
            o: 153.775,
            c: 150.87,
            h: 154.33,
            l: 150.42,
            t: 1675918800000,
            n: 471973,
            averageC: 152.48,
            averageO: 152.765,
            averageH: 154.71333333333337,
            averageL: 150.74266666666668,
          },
          {
            v: 57388108,
            vw: 150.4054,
            o: 149.46,
            c: 151.01,
            h: 151.3401,
            l: 149.22,
            t: 1676005200000,
            n: 443405,
            averageC: 151.26666666666665,
            averageO: 152.37166666666667,
            averageH: 153.41670000000002,
            averageL: 150.26933333333338,
          },
        ],
        status: "OK",
        request_id: "5506d5da40cde86e7c6e011f29c9f730",
      },
    ]);
  });

  it("successfully transforms MSFT stock prices for last 5 days average", () => {
    const formattedResponse = formatLastNDaysAverage(
      MOCK_AGGREGATES_MSFT_DATA,
      5
    );
    expect(formattedResponse[0].results.length).toEqual(
      formattedResponse[0].resultsCount
    );
    expect(formattedResponse[0].ticker).toEqual("MSFT");
    expect(formattedResponse).toEqual([
      {
        ticker: "MSFT",
        queryCount: 24,
        resultsCount: 24,
        adjusted: true,
        results: [
          {
            v: 27369784,
            vw: 228.5989,
            o: 226.45,
            c: 227.12,
            h: 231.2366,
            l: 226.41,
            t: 1673240400000,
            n: 363680,
            averageC: 227.12,
            averageO: 226.45,
            averageH: 231.2366,
            averageL: 226.41,
          },
          {
            v: 27033881,
            vw: 228.7878,
            o: 227.755,
            c: 228.85,
            h: 231.31,
            l: 227.33,
            t: 1673326800000,
            n: 334659,
            averageC: 227.985,
            averageO: 227.1025,
            averageH: 231.2733,
            averageL: 226.87,
          },
          {
            v: 28633081,
            vw: 233.9843,
            o: 231.29,
            c: 235.77,
            h: 235.95,
            l: 231.11,
            t: 1673413200000,
            n: 340052,
            averageC: 230.58,
            averageO: 228.49833333333333,
            averageH: 232.83219999999997,
            averageL: 228.28333333333333,
          },
          {
            v: 27269486,
            vw: 237.813,
            o: 235.26,
            c: 238.51,
            h: 239.9,
            l: 233.56,
            t: 1673499600000,
            n: 400489,
            averageC: 232.5625,
            averageO: 230.18875,
            averageH: 234.59914999999998,
            averageL: 229.60250000000002,
          },
          {
            v: 21333265,
            vw: 237.4748,
            o: 237.002,
            c: 239.23,
            h: 239.37,
            l: 234.92,
            t: 1673586000000,
            n: 300118,
            averageC: 233.89600000000002,
            averageO: 231.5514,
            averageH: 235.55331999999999,
            averageL: 230.66600000000003,
          },
          {
            v: 29831257,
            vw: 239.6706,
            o: 237.97,
            c: 240.35,
            h: 240.91,
            l: 237.09,
            t: 1673931600000,
            n: 370168,
            averageC: 236.542,
            averageO: 233.8554,
            averageH: 237.488,
            averageL: 232.80200000000005,
          },
          {
            v: 30028692,
            vw: 237.875,
            o: 241.565,
            c: 235.81,
            h: 242.38,
            l: 235.52,
            t: 1674018000000,
            n: 377927,
            averageC: 237.93400000000003,
            averageO: 236.6174,
            averageH: 239.70200000000006,
            averageL: 234.44000000000005,
          },
          {
            v: 28592433,
            vw: 232.5374,
            o: 233.78,
            c: 231.93,
            h: 235.52,
            l: 230.68,
            t: 1674104400000,
            n: 362262,
            averageC: 237.16600000000003,
            averageO: 237.1154,
            averageH: 239.61600000000004,
            averageL: 234.35400000000004,
          },
          {
            v: 35249809,
            vw: 238.2032,
            o: 234.855,
            c: 240.22,
            h: 240.74,
            l: 234.51,
            t: 1674190800000,
            n: 364051,
            averageC: 237.50800000000004,
            averageO: 237.0344,
            averageH: 239.78400000000002,
            averageL: 234.54400000000004,
          },
          {
            v: 31933951,
            vw: 242.7509,
            o: 241.1,
            c: 242.58,
            h: 245.165,
            l: 239.65,
            t: 1674450000000,
            n: 413335,
            averageC: 238.17800000000003,
            averageO: 237.85399999999998,
            averageH: 240.94300000000004,
            averageL: 235.49000000000007,
          },
          {
            v: 40218444,
            vw: 243.7867,
            o: 242.5,
            c: 242.04,
            h: 243.95,
            l: 240.44,
            t: 1674536400000,
            n: 512442,
            averageC: 238.51600000000002,
            averageO: 238.76,
            averageH: 241.55100000000002,
            averageL: 236.16000000000003,
          },
          {
            v: 66526641,
            vw: 237.4755,
            o: 234.48,
            c: 240.61,
            h: 243.3,
            l: 230.9,
            t: 1674622800000,
            n: 745426,
            averageC: 239.47600000000003,
            averageO: 237.343,
            averageH: 241.73500000000004,
            averageL: 235.23600000000005,
          },
          {
            v: 33454491,
            vw: 245.411,
            o: 243.65,
            c: 248,
            h: 248.31,
            l: 242,
            t: 1674709200000,
            n: 401891,
            averageC: 242.69,
            averageO: 239.317,
            averageH: 244.29300000000003,
            averageL: 237.50000000000006,
          },
          {
            v: 26498939,
            vw: 248.3935,
            o: 248.99,
            c: 248.16,
            h: 249.83,
            l: 246.83,
            t: 1674795600000,
            n: 336282,
            averageC: 244.27800000000002,
            averageO: 242.144,
            averageH: 246.11100000000002,
            averageL: 239.96400000000003,
          },
          {
            v: 25867365,
            vw: 243.2164,
            o: 244.51,
            c: 242.71,
            h: 245.6,
            l: 242.2,
            t: 1675054800000,
            n: 308895,
            averageC: 244.304,
            averageO: 242.82600000000002,
            averageH: 246.198,
            averageL: 240.47400000000002,
          },
          {
            v: 26541072,
            vw: 246.5374,
            o: 243.45,
            c: 247.81,
            h: 247.95,
            l: 242.945,
            t: 1675141200000,
            n: 256082,
            averageC: 245.458,
            averageO: 243.01600000000002,
            averageH: 246.998,
            averageL: 240.975,
          },
          {
            v: 31259912,
            vw: 250.3172,
            o: 248,
            c: 252.75,
            h: 255.18,
            l: 245.47,
            t: 1675227600000,
            n: 386960,
            averageC: 247.88599999999997,
            averageO: 245.72000000000003,
            averageH: 249.37400000000002,
            averageL: 243.88899999999998,
          },
          {
            v: 39931837,
            vw: 261.6241,
            o: 258.82,
            c: 264.6,
            h: 264.69,
            l: 257.25,
            t: 1675314000000,
            n: 533818,
            averageC: 251.20599999999996,
            averageO: 248.75400000000005,
            averageH: 252.65000000000003,
            averageL: 246.939,
          },
          {
            v: 29059256,
            vw: 259.9308,
            o: 259.542,
            c: 258.35,
            h: 264.2,
            l: 257.1,
            t: 1675400400000,
            n: 408058,
            averageC: 253.24399999999997,
            averageO: 250.86440000000002,
            averageH: 255.52400000000003,
            averageL: 248.993,
          },
          {
            v: 22517997,
            vw: 256.76,
            o: 257.44,
            c: 256.77,
            h: 258.3,
            l: 254.78,
            t: 1675659600000,
            n: 276674,
            averageC: 256.0559999999999,
            averageO: 253.45040000000003,
            averageH: 258.064,
            averageL: 251.50899999999996,
          },
          {
            v: 50841365,
            vw: 264.6898,
            o: 260.53,
            c: 267.56,
            h: 268.775,
            l: 260.08,
            t: 1675746000000,
            n: 618791,
            averageC: 260.006,
            averageO: 256.8664,
            averageH: 262.229,
            averageL: 254.93599999999998,
          },
          {
            v: 54674349,
            vw: 270.3434,
            o: 273.2,
            c: 266.73,
            h: 276.76,
            l: 266.21,
            t: 1675832400000,
            n: 659530,
            averageC: 262.80199999999996,
            averageO: 261.9064,
            averageH: 266.54499999999996,
            averageL: 259.08399999999995,
          },
          {
            v: 42375102,
            vw: 267.304,
            o: 273.8,
            c: 263.62,
            h: 273.98,
            l: 262.8,
            t: 1675918800000,
            n: 472027,
            averageC: 262.60599999999994,
            averageO: 264.90240000000006,
            averageH: 268.40299999999996,
            averageL: 260.19399999999996,
          },
          {
            v: 25808489,
            vw: 262.4025,
            o: 261.53,
            c: 263.1,
            h: 264.09,
            l: 260.662,
            t: 1676005200000,
            n: 334145,
            averageC: 263.5559999999999,
            averageO: 265.30000000000007,
            averageH: 268.381,
            averageL: 260.90639999999996,
          },
        ],
        status: "OK",
        request_id: "d44053310a562f2d81e7debaa4490d62",
        count: 24,
      },
    ]);
  });
});
